<!DOCTYPE html>
<html lang="en">
<head>
Â Â <meta charset="utf-8" />
Â Â <meta name="viewport" content="width=device-width, initial-scale=1" />
Â Â <title>Progression Playground</title>
Â Â <style>
Â Â Â Â :root{--bg:#0f1220;--panel:#161a2a;--panel2:#1c2136;--accent:#8bd3dd;--muted:#9aa3b2;--text:#eef2ff}
Â Â Â Â *{box-sizing:border-box}
Â Â Â Â body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0b0e1a);color:var(--text)}
Â Â Â Â header{padding:20px 24px;border-bottom:1px solid #1f2540;background:radial-gradient(1200px 400px at 10% -50%,#1d2444 0,#14182a 60%,transparent 100%)}
Â Â Â Â h1{margin:0;font-size:20px;letter-spacing:0.4px}
Â Â Â Â main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:16px}
Â Â Â Â .card{background:var(--panel);border:1px solid #242a46;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
Â Â Â Â .card .hd{padding:14px 16px;border-bottom:1px solid #212744;font-weight:600;color:#c6d0f7}
Â Â Â Â .card .bd{padding:14px 16px}
Â Â Â Â label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
Â Â Â Â select,input[type=number],input[type=text],input[type=range]{width:100%;background:var(--panel2);border:1px solid #2a3154;color:var(--text);border-radius:10px;padding:10px;font-size:14px;outline:none}
Â Â Â Â input[type=range]{padding:0}
Â Â Â Â .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
Â Â Â Â button{appearance:none;border:none;background:var(--accent);color:#071318;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.25)}
Â Â Â Â button.secondary{background:#2a3154;color:#dbe4ff}
Â Â Â Â button:disabled{opacity:.6;cursor:not-allowed}
Â Â Â Â .stack{display:flex;gap:8px;flex-wrap:wrap}
Â Â Â Â .muted{color:var(--muted)}
Â Â Â Â .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
Â Â Â Â .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#232a48;border:1px solid #2a3154;margin:4px 4px 0 0;font-size:12px}
Â Â Â Â .big{font-size:18px}
Â Â Â Â .kbd{background:#0b0f1f;border:1px solid #2a3154;border-radius:6px;padding:2px 6px}
Â Â Â Â .footer{padding:14px 16px;border-top:1px solid #212744;display:flex;gap:8px;flex-wrap:wrap}
Â Â Â Â .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
Â Â Â Â .list{display:flex;flex-direction:column;gap:8px}
Â Â Â Â details{background:#12162a;border:1px solid #242a46;border-radius:12px;padding:8px}
Â Â Â Â summary{cursor:pointer;color:#c8d1ff}
Â Â Â Â .code{white-space:pre-wrap;background:#0b0f1f;border:1px solid #2a3154;border-radius:12px;padding:10px}
Â Â </style>
</head>
<body>
Â Â <header>
Â Â Â Â <h1>ğŸ¹ Progression Playground <span class="muted">â€” spin nonâ€‘Western & Western progressions, hear them, export MIDI</span></h1>
Â Â </header>

Â Â <main>
Â Â Â Â <section class="card">
Â Â Â Â Â Â <div class="hd">Setup</div>
Â Â Â Â Â Â <div class="bd">
Â Â Â Â Â Â Â Â <label>Tradition / Mode</label>
Â Â Â Â Â Â Â Â <select id="modeSel"></select>

Â Â Â Â Â Â Â Â <div class="row">
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label>Key / Tonic</label>
Â Â Â Â Â Â Â Â Â Â Â Â <select id="keySel"></select>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label>Length (bars)</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input id="lenInp" type="number" min="4" max="32" step="1" value="8" />
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <label>Surprise (randomness weight)</label>
Â Â Â Â Â Â Â Â <input id="surprise" type="range" min="0" max="100" value="40" />
Â Â Â Â Â Â Â Â <div class="muted">Lower = safer cadences Â· Higher = wilder color moves</div>

Â Â Â Â Â Â Â Â <div class="row" style="margin-top:12px">
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label>Tempo (BPM)</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input id="tempo" type="number" value="96" min="40" max="220" />
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label>Voicing</label>
Â Â Â Â Â Â Â Â Â Â Â Â <select id="voicing">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option value="block">Block chords</option>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <option value="arp">Arpeggiate</option>
Â Â Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <div class="row" style="margin-top:8px">
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label><input type="checkbox" id="drone" checked> Drone (tonic & fifth)</label>
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â Â Â <label>Master Volume</label>
Â Â Â Â Â Â Â Â Â Â Â Â <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" />
Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â <div class="stack" style="margin-top:12px">
Â Â Â Â Â Â Â Â Â Â <button id="generateBtn">ğŸ² Spin progression</button>
Â Â Â Â Â Â Â Â Â Â <button id="playBtn" class="secondary" disabled>â–¶ï¸ Play</button>
Â Â Â Â Â Â Â Â Â Â <button id="stopBtn" class="secondary" disabled>â¹ Stop</button>
Â Â Â Â Â Â Â Â Â Â <button id="exportBtn" disabled>ğŸ’¾ Export MIDI</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="footer">
Â Â Â Â Â Â Â Â <span class="kbd">Tip:</span>
Â Â Â Â Â Â Â Â <span class="muted">Use the related variations to reshape a verse/chorus quickly.</span>
Â Â Â Â Â Â </div>
Â Â Â Â </section>

Â Â Â Â <section class="card">
Â Â Â Â Â Â <div class="hd">Result</div>
Â Â Â Â Â Â <div class="bd">
Â Â Â Â Â Â Â Â <div id="result"></div>
Â Â Â Â Â Â Â Â <div id="vars"></div>
Â Â Â Â Â Â Â Â <details style="margin-top:10px">
Â Â Â Â Â Â Â Â Â Â <summary>Show raw JSON</summary>
Â Â Â Â Â Â Â Â Â Â <div id="json" class="code mono"></div>
Â Â Â Â Â Â Â Â </details>
Â Â Â Â Â Â </div>
Â Â Â Â </section>
Â Â </main>

<script>
// -------------------------- Theory utilities & data --------------------------
const NOTE_TO_SEMI = {C:0, 'C#':1, Db:1, D:2, 'D#':3, Eb:3, E:4, F:5, 'F#':6, Gb:6, G:7, 'G#':8, Ab:8, A:9, 'A#':10, Bb:10, B:11};
const SEMI_TO_NOTE = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const KEYS = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

function transposeNoteName(name, semi){
Â Â const base = NOTE_TO_SEMI[name];
Â Â const out = (base + semi + 1200) % 12;
Â Â return SEMI_TO_NOTE[out];
}

// Modes / grammars (compact, adapted from our earlier prototype)
const MODES = {
Â Â 'Western Major': {
Â Â Â Â tonic: 'C',
Â Â Â Â chordMap: {T:'I', S:'IV', D:'V'},
Â Â Â Â functions: ['T','S','D'],
Â Â Â Â edges: { T:[['S',0.6],['D',0.4],['T',0.2]], S:[['D',0.8],['T',0.2]], D:[['T',1.0],['S',0.2]] },
Â Â Â Â cadences: [['D','T'], ['S','D','T']],
Â Â Â Â realize: (fn,key)=> degreeToTriad(({T:'I', S:'IV', D:'V'})[fn]||'I', key, 'major')
Â Â },
Â Â 'Dorian': {
Â Â Â Â tonic:'D',
Â Â Â Â chordMap:{t:'i', P:'IV', X:'bVII'},
Â Â Â Â functions:['t','P','X'],
Â Â Â Â edges:{ t:[['P',0.7],['X',0.5],['t',0.3]], P:[['t',0.7],['X',0.4]], X:[['t',0.8],['P',0.3]] },
Â Â Â Â cadences:[['P','t'],['X','t']],
Â Â Â Â realize:(deg,key)=> modalRealizeDorian(deg,key)
Â Â },
Â Â 'Hijaz': {
Â Â Â Â tonic:'C',
Â Â Â Â chordMap:{I:'I', bII:'bII', III:'III', bVI:'bVI', bVII:'bVII'},
Â Â Â Â functions:['I','bII','III','bVI','bVII'],
Â Â Â Â edges:{ I:[['bII',0.8],['III',0.6],['I',0.3]], bII:[['III',0.7],['I',0.5],['bVI',0.3]], III:[['I',0.8],['bVI',0.5]], bVI:[['bVII',0.6],['I',0.6]], bVII:[['I',1.0],['bII',0.3]] },
Â Â Â Â cadences:[['bII','III','I'],['bVII','I']],
Â Â Â Â realize:(deg,key)=> hijazRealize(deg,key)
Â Â },
Â Â 'Bhairav (inspired)': {
Â Â Â Â tonic:'C',
Â Â Â Â chordMap:{Sa:'I5', Re:'bII', Ga:'III', Ma:'IV', Pa:'V', Dha:'bVI', Ni:'VIIo'},
Â Â Â Â functions:['Sa','Re','Ga','Ma','Pa','Dha','Ni'],
Â Â Â Â edges:{ Sa:[['Re',0.6],['Ga',0.5],['Sa',0.3]], Re:[['Ga',0.7],['Ma',0.4],['Sa',0.3]], Ga:[['Sa',0.7],['Ma',0.6]], Ma:[['Pa',0.8],['Ga',0.4]], Pa:[['Dha',0.7],['Ga',0.3],['Sa',0.2]], Dha:[['Ni',0.6],['Pa',0.4]], Ni:[['Sa',1.0]] },
Â Â Â Â cadences:[['Ni','Sa'],['Pa','Ni','Sa']],
Â Â Â Â realize:(deg,key)=> bhairavRealize(deg,key)
Â Â },
Â Â 'In Sen (JP)': {
Â Â Â Â tonic:'C',
Â Â Â Â chordMap:{C5:'C5', Db:'bII', 'Bb-':'bVII-', F:'IV5'},
Â Â Â Â functions:['C5','Db','Bb-','F'],
Â Â Â Â edges:{ C5:[['Db',0.8],['Bb-',0.5],['C5',0.3]], Db:[['Bb-',0.7],['F',0.4],['C5',0.3]], 'Bb-':[['C5',0.9],['F',0.5]], F:[['C5',1.0]] },
Â Â Â Â cadences:[['F','C5'],['Bb-','C5']],
Â Â Â Â realize:(deg,key)=> inSenRealize(deg,key)
Â Â },
Â Â 'Mbira Cycle (Zim)': {
Â Â Â Â tonic:'C',
Â Â Â Â chordMap:{A:'I',B:'V',C:'IV',D:'I'},
Â Â Â Â functions:['A','B','C','D'],
Â Â Â Â edges:{ A:[['B',1]], B:[['C',1]], C:[['D',1]], D:[['A',1]] },
Â Â Â Â cadences:[['C','D','A']],
Â Â Â Â realize:(deg,key)=> mbiraRealize(deg,key)
Â Â }
};

// Degree â†’ chord realization helpers
function degreeToTriad(deg, key, type){
Â Â // Supports I ii iii IV V vi viiÂ° with accidentals bII, bVII, etc.
Â Â const DEGREE_TO_SEMI = { I:0, i:0, ii:2, 'iiÂ°':2, III:4, iii:4, bIII:3, IV:5, iv:5, V:7, v:7, vi:9, bVI:8, vii:11, 'viiÂ°':11, bVII:10, 'I5':0, 'IV5':5 };
Â Â const offset = DEGREE_TO_SEMI[deg] ?? 0;
Â Â const keySemi = NOTE_TO_SEMI[key];
Â Â const root = (keySemi + offset) % 12;
Â Â const rootName = SEMI_TO_NOTE[root];
Â Â if (deg.endsWith('5')) return {name:`${rootName}5`, notes:[root+60, root+67]};
Â Â if (deg.includes('Â°')) return {name:`${rootName}dim`, notes:[root+60, root+60+3, root+60+6]};
Â Â const quality = (['I','IV','V','bII','III','bVI','bVII','bIII'].includes(deg)||type==='major')?'maj':'min';
Â Â const third = quality==='maj'?4:3;
Â Â const fifth = 7;
Â Â return {name:`${rootName}${quality==='maj'?'':'m'}`, notes:[root+60, root+60+third, root+60+fifth]};
}

function modalRealizeDorian(fn,key){
Â Â if (fn==='t') return degreeToTriad('i',key,'minor');
Â Â if (fn==='P') return degreeToTriad('IV',key,'major');
Â Â if (fn==='X') return degreeToTriad('bVII',key,'major');
Â Â return degreeToTriad('i',key,'minor');
}

function hijazRealize(fn,key){
Â Â // Prefer open 5ths or sus to keep maqam flavor, plus special III major color
Â Â const map = {
Â Â Â Â 'I': () => degreeToTriad('I5',key,'major'),
Â Â Â Â 'bII': () => degreeToTriad('bII',key,'major'),
Â Â Â Â 'III': () => degreeToTriad('III',key,'major'),
Â Â Â Â 'bVI': () => degreeToTriad('bVI',key,'major'),
Â Â Â Â 'bVII': () => degreeToTriad('bVII',key,'major')
Â Â };
Â Â return (map[fn]||map['I'])();
}

function bhairavRealize(fn,key){
Â Â const map = {
Â Â Â Â 'Sa': () => degreeToTriad('I5',key,'major'),
Â Â Â Â 'Re': () => degreeToTriad('bII',key,'major'),
Â Â Â Â 'Ga': () => degreeToTriad('III',key,'major'),
Â Â Â Â 'Ma': () => degreeToTriad('IV',key,'major'),
Â Â Â Â 'Pa': () => degreeToTriad('V',key,'major'),
Â Â Â Â 'Dha': () => degreeToTriad('bVI',key,'major'),
Â Â Â Â 'Ni': () => ({name:'leading dim', notes:[NOTE_TO_SEMI[key]+11+60, NOTE_TO_SEMI[key]+11+60+3, NOTE_TO_SEMI[key]+11+60+6]})
Â Â };
Â Â return (map[fn]||map['Sa'])();
}

function inSenRealize(fn,key){
Â Â if (fn==='C5') return degreeToTriad('I5',key,'major');
Â Â if (fn==='Db') return degreeToTriad('bII',key,'major');
Â Â if (fn==='Bb-') return degreeToTriad('bVII',key,'minor');
Â Â if (fn==='F') return degreeToTriad('IV5',key,'major');
Â Â return degreeToTriad('I5',key,'major');
}

function mbiraRealize(fn,key){
Â Â const map = {A:'I',B:'V',C:'IV',D:'I'};
Â Â return degreeToTriad(map[fn], key, 'major');
}

// Weighted choice helper with surprise scaling
function chooseWeighted(options, surprise){
Â Â const scaled = options.map(([k,w])=>[k, Math.max(0.0001, w * (0.6 + surprise*0.01))]);
Â Â const total = scaled.reduce((a,[_k,w])=>a+w,0);
Â Â let r = Math.random() * total, acc = 0;
Â Â for (const [k,w] of scaled){acc += w; if (r <= acc) return k;} return scaled[scaled.length-1][0];
}

function generateFunctions(mode, bars, surprise){
Â Â const fns = [mode.functions[0]]; // start at home
Â Â while (fns.length < Math.max(2,bars-2)){
Â Â Â Â const last = fns[fns.length-1];
Â Â Â Â const next = chooseWeighted(mode.edges[last]||[[last,1]], surprise/100);
Â Â Â Â fns.push(next);
Â Â }
Â Â const cad = mode.cadences[Math.floor(Math.random()*mode.cadences.length)]||[mode.functions[0]];
Â Â return [...fns, ...cad].slice(0, bars);
}

function relatedVariations(funcs, mode){
Â Â const ring = mode.functions;
Â Â const subst = {T:'t', t:'T', S:'P', P:'S', D:'X', X:'D', I:'I', IV:'ii', V:'v', ii:'IV', v:'V', A:'B', B:'A'};
Â Â const cyclic_slice = (funcs.length>=6?funcs.slice(2, Math.min(funcs.length-1, 6)):funcs).concat(funcs.slice(2, Math.min(funcs.length-1, 6)));
Â Â const borrowed_colors = funcs.map(f=>subst[f]||f);
Â Â const shift = Math.random()<0.5?-1:1;
Â Â const sidestep = funcs.map(f=> ring.includes(f) ? ring[(ring.indexOf(f)+shift+ring.length)%ring.length] : f);
Â Â return {cyclic_slice, borrowed_colors, sidestep};
}

function realizeProgression(funcs, mode, key){
Â Â return funcs.map(fn=> mode.realize(fn,key));
}

// -------------------------- WebAudio playback --------------------------
let audioCtx; let playing = false; let scheduled = [];
function ensureAudio(){ if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }

function playProgression(chords, bpm, voicing, droneOn, volume){
Â Â ensureAudio();
Â Â stopAll();
Â Â const secPerBeat = 60/bpm, beatsPerBar = 4;
Â Â const start = audioCtx.currentTime + 0.05;
Â Â const master = audioCtx.createGain(); master.gain.value = volume; master.connect(audioCtx.destination);

Â Â // optional drone
Â Â if (droneOn){
Â Â Â Â const root = chords[0].notes[0] % 12; // from first chord root
Â Â Â Â const midiToHz = m=> 440*Math.pow(2, (m-69)/12);
Â Â Â Â const tones = [root+48, root+55];
Â Â Â Â tones.forEach(m=>{
Â Â Â Â Â Â const o = audioCtx.createOscillator(); o.type='triangle'; o.frequency.value = midiToHz(m);
Â Â Â Â Â Â const g = audioCtx.createGain(); g.gain.value = 0.08; o.connect(g).connect(master); o.start(start); o.stop(start + chords.length*beatsPerBar*secPerBeat + 0.2); scheduled.push(o);
Â Â Â Â });
Â Â }

Â Â const midiToHz = m=> 440*Math.pow(2, (m-69)/12);
Â Â let t = start;
Â Â chords.forEach((ch, i)=>{
Â Â Â Â const dur = beatsPerBar*secPerBeat;
Â Â Â Â const notes = ch.notes;
Â Â Â Â if (voicing==='arp'){
Â Â Â Â Â Â notes.forEach((m, k)=>{ scheduleTone(m, t + k*0.12, dur-0.05); });
Â Â Â Â } else {
Â Â Â Â Â Â notes.forEach(m=> scheduleTone(m, t, dur-0.05));
Â Â Â Â }
Â Â Â Â t += dur;
Â Â });

Â Â function scheduleTone(midi, when, dur){
Â Â Â Â const o = audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.value = midiToHz(midi);
Â Â Â Â const g = audioCtx.createGain(); const envA=0.01, envD=0.08; g.gain.setValueAtTime(0, when); g.gain.linearRampToValueAtTime(0.28, when+envA); g.gain.linearRampToValueAtTime(0.16, when+envA+envD); g.gain.setTargetAtTime(0, when+dur-0.05, 0.03);
Â Â Â Â o.connect(g).connect(master); o.start(when); o.stop(when+dur+0.05); scheduled.push(o);
Â Â }

Â Â playing = true;
}

function stopAll(){
Â Â scheduled.forEach(n=>{try{n.stop(0)}catch{}}); scheduled=[]; playing=false;
}

// -------------------------- MIDI export (Type 0) --------------------------
function writeVarLen(value){
Â Â let buffer = value & 0x7F; let bytes = [];
Â Â while ((value >>= 7)) { buffer <<= 8; buffer |= ((value & 0x7F) | 0x80); }
Â Â while (true) { bytes.push(buffer & 0xFF); if (buffer & 0x80) buffer >>= 8; else break; }
Â Â return bytes;
}

function buildMIDI(chords, bpm){
Â Â const PPQ = 480; const MICROSPERQN = Math.round(60000000 / bpm);
Â Â const events = [];
Â Â // tempo meta
Â Â events.push(...[0x00, 0xFF, 0x51, 0x03, (MICROSPERQN>>16)&255, (MICROSPERQN>>8)&255, MICROSPERQN&255]);
Â Â // program change to piano
Â Â events.push(...[0x00, 0xC0, 0x00]);
Â Â // notes
Â Â const beatsPerBar = 4; const ticksPerBeat = PPQ; const barTicks = beatsPerBar * ticksPerBeat;
Â Â let time = 0;
Â Â chords.forEach(ch=>{
Â Â Â Â // Note on all at bar start
Â Â Â Â events.push(...writeVarLen(time)); time = 0; // delta since last event
Â Â Â Â ch.notes.forEach(n=> events.push(0x90, n, 96)); // velocity 96
Â Â Â Â // Note off after bar
Â Â Â Â events.push(...writeVarLen(barTicks));
Â Â Â Â ch.notes.forEach(n=> events.push(0x80, n, 64));
Â Â });
Â Â // End of track
Â Â events.push(...[0x00, 0xFF, 0x2F, 0x00]);

Â Â // Wrap into MTrk chunk
Â Â const trackData = Uint8Array.from(events);
Â Â const trk = new Uint8Array(8 + trackData.length);
Â Â trk.set([0x4d,0x54,0x72,0x6b, (trackData.length>>24)&255, (trackData.length>>16)&255, (trackData.length>>8)&255, trackData.length&255]);
Â Â trk.set(trackData, 8);

Â Â // Header chunk MThd format 0, 1 track, PPQ
Â Â const hdr = new Uint8Array([0x4d,0x54,0x68,0x64, 0x00,0x00,0x00,0x06, 0x00,0x00, 0x00,0x01, (PPQ>>8)&255, PPQ&255]);
Â Â const full = new Uint8Array(hdr.length + trk.length);
Â Â full.set(hdr); full.set(trk, hdr.length);
Â Â return new Blob([full], {type:'audio/midi'});
}

// -------------------------- UI wiring --------------------------
const modeSel = document.getElementById('modeSel');
const keySel = document.getElementById('keySel');
const lenInp = document.getElementById('lenInp');
const surprise = document.getElementById('surprise');
const tempo = document.getElementById('tempo');
const voicing = document.getElementById('voicing');
const drone = document.getElementById('drone');
const volume = document.getElementById('volume');
const result = document.getElementById('result');
const varsDiv = document.getElementById('vars');
const jsonDiv = document.getElementById('json');
const genBtn = document.getElementById('generateBtn');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const exportBtn = document.getElementById('exportBtn');

let current = null; // {mode, key, functions, chords}

function init(){
Â Â Object.keys(MODES).forEach(k=>{
Â Â Â Â const op = document.createElement('option'); op.value=k; op.textContent=k; modeSel.appendChild(op);
Â Â });
Â Â KEYS.forEach(k=>{ const op=document.createElement('option'); op.value=k; op.textContent=k; keySel.appendChild(op); });
Â Â modeSel.value='Hijaz'; keySel.value='C';
}

function realizeToKey(chords, key){
Â Â // transpose from C-relative notes to selected key: we built notes around key already, so nothing special here
Â Â return chords; // chords already realized in given key
}

function render(){
Â Â if (!current) return;
Â Â const {modeName, key, functions, chords, variations, notes} = current;
Â Â const fnPills = functions.map(f=>`<span class="pill mono">${f}</span>`).join('');
Â Â const chPills = chords.map(ch=>`<span class="pill mono">${ch.name}</span>`).join('');
Â Â result.innerHTML = `
Â Â Â Â <div class="list">
Â Â Â Â Â Â <div class="big">${modeName} in <strong>${key}</strong></div>
Â Â Â Â Â Â <div>Functions: ${fnPills}</div>
Â Â Â Â Â Â <div>Chords: ${chPills}</div>
Â Â Â Â Â Â <div class="muted">${Object.values(notes||{}).join(' Â· ')}</div>
Â Â Â Â </div>`;

Â Â varsDiv.innerHTML = '';
Â Â for (const [label, fnSeq] of Object.entries(variations)){
Â Â Â Â const chordsV = realizeProgression(fnSeq, MODES[modeName], key);
Â Â Â Â const pillsFns = fnSeq.map(f=>`<span class="pill mono">${f}</span>`).join('');
Â Â Â Â const pillsCh = chordsV.map(ch=>`<span class="pill mono">${ch.name}</span>`).join('');
Â Â Â Â const box = document.createElement('div'); box.className='card'; box.style.marginTop='10px';
Â Â Â Â box.innerHTML = `<div class="hd">Related: ${label}</div><div class="bd">${pillsFns}<div style="margin-top:6px">${pillsCh}</div><div class="footer"><button class="secondary" data-apply="${label}">Use this</button></div></div>`;
Â Â Â Â varsDiv.appendChild(box);
Â Â }
Â Â jsonDiv.textContent = JSON.stringify(current, null, 2);

Â Â playBtn.disabled = false; exportBtn.disabled = false; stopBtn.disabled = false;
}

init();

genBtn.addEventListener('click', ()=>{
Â Â const modeName = modeSel.value; const mode = MODES[modeName];
Â Â const key = keySel.value; const bars = parseInt(lenInp.value||'8',10); const s = parseInt(surprise.value,10);
Â Â const fns = generateFunctions(mode, bars, s);
Â Â const chords = realizeProgression(fns, mode, key);
Â Â const variations = relatedVariations(fns, mode);
Â Â current = {modeName, key, functions:fns, chords, variations, notes:{info:'See mode rules inside code'}};
Â Â render();
});

varsDiv.addEventListener('click', (e)=>{
Â Â const btn = e.target.closest('button[data-apply]'); if (!btn || !current) return;
Â Â const mode = MODES[current.modeName]; const key = current.key; const variant = btn.getAttribute('data-apply');
Â Â const fnSeq = current.variations[variant];
Â Â current.functions = fnSeq; current.chords = realizeProgression(fnSeq, mode, key);
Â Â render();
});

playBtn.addEventListener('click', ()=>{ if (!current) return; playProgression(current.chords, parseInt(tempo.value,10), voicing.value, drone.checked, parseFloat(volume.value)); });
stopBtn.addEventListener('click', ()=> stopAll());
exportBtn.addEventListener('click', ()=>{
Â Â if (!current) return;
Â Â const blob = buildMIDI(current.chords, parseInt(tempo.value,10));
Â Â const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
Â Â a.download = `${current.modeName}_${current.key}_${Date.now()}.mid`; a.click();
Â Â URL.revokeObjectURL(a.href);
});
</script>
</body>
</html>
